/*
	Kailash Nadh (http://nadh.in)
	
	localStorageDB
	September 2011
	A simple database layer for localStorage

	v 1.9 November 2012
	v 2.0 June 2013
	v 2.1 Nov 2013

	License	:	MIT License
*/

function localStorageDB(e,t){function a(){delete o[r];s=null}function f(){var e=0;for(var t in s.tables){if(s.tables.hasOwnProperty(t)){e++}}return e}function l(e){return s.tables[e]?true:false}function c(e){if(!l(e)){k("The table '"+e+"' does not exist.")}}function h(e,t){var n=false;var r=s.tables[e].fields;for(var i in r){if(r[i]==t){n=true;break}}return n}function p(e,t){s.tables[e]={fields:t,auto_increment:1};s.data[e]={}}function d(e){delete s.tables[e];delete s.data[e]}function v(e){s.tables[e].auto_increment=1;s.data[e]={}}function m(e,t,n){s.tables[e].fields=s.tables[e].fields.concat(t);if(typeof n!="undefined"){for(var r in s.data[e]){if(!s.data[e].hasOwnProperty(r)){continue}for(var i in t){if(typeof n=="object")s.data[e][r][t[i]]=n[t[i]];else s.data[e][r][t[i]]=n}}}}function g(e){var t=0;for(var n in s.data[e]){if(s.data[e].hasOwnProperty(n)){t++}}return t}function y(e,t){t.ID=s.tables[e].auto_increment;s.data[e][s.tables[e].auto_increment]=t;s.tables[e].auto_increment++;return t.ID}function b(e,t){var n=null,r=[],i=null;for(var o=0;o<t.length;o++){n=t[o];i=s.data[e][n];r.push(L(i))}return r}function w(e,t,n){var r=[],i=false,o=null;for(var u in s.data[e]){if(!s.data[e].hasOwnProperty(u)){continue}o=s.data[e][u];i=true;for(var a in t){if(!t.hasOwnProperty(a)){continue}if(typeof t[a]=="string"){if(o[a].toString().toLowerCase()!=t[a].toString().toLowerCase()){i=false;break}}else{if(o[a]!=t[a]){i=false;break}}}if(i){r.push(u)}if(r.length==n){break}}return r}function E(e,t,n){var r=[],i=false,o=null;for(var u in s.data[e]){if(!s.data[e].hasOwnProperty(u)){continue}o=s.data[e][u];if(t(L(o))==true){r.push(u)}if(r.length==n){break}}return r}function S(e,t){var n=[];for(var r in s.data[e]){if(s.data[e].hasOwnProperty(r)){n.push(r);if(n.length==t){break}}}return n}function x(e,t){for(var n=0;n<t.length;n++){if(s.data[e].hasOwnProperty(t[n])){delete s.data[e][t[n]]}}return t.length}function T(e,t,n){var r="",i=0;for(var o=0;o<t.length;o++){r=t[o];var u=n(L(s.data[e][r]));if(u){delete u["ID"];var a=s.data[e][r];for(var f in u){if(u.hasOwnProperty(f)){a[f]=u[f]}}s.data[e][r]=O(e,a);i++}}return i}function N(){try{o[r]=JSON.stringify(s);return true}catch(e){return false}}function C(){return JSON.stringify(s)}function k(e){throw new Error(e)}function L(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t}function A(e){return e.match(/[^a-z_0-9]/ig)?false:true}function O(e,t){var n="",r={};for(var i=0;i<s.tables[e].fields.length;i++){n=s.tables[e].fields[i];if(t[n]!==null&&t[n]!==undefined){r[n]=t[n]}}return r}function M(e,t){var n="",r={};for(var i=0;i<s.tables[e].fields.length;i++){n=s.tables[e].fields[i];r[n]=t[n]===null||t[n]===undefined?null:t[n]}return r}var n="db_",r=n+e,i=false,s=null;try{var o=t==sessionStorage?sessionStorage:localStorage}catch(u){var o=t}s=o[r];if(!(s&&(s=JSON.parse(s))&&s.tables&&s.data)){if(!A(e)){k("The name '"+e+"'"+" contains invalid characters.")}else{s={tables:{},data:{}};N();i=true}}return{commit:function(){return N()},isNew:function(){return i},drop:function(){a()},serialize:function(){return C()},tableExists:function(e){return l(e)},tableCount:function(){return f()},columnExists:function(e,t){return h(e,t)},createTable:function(e,t){var n=false;if(!A(e)){k("The database name '"+e+"'"+" contains invalid characters.")}else if(this.tableExists(e)){k("The table name '"+e+"' already exists.")}else{var r=true;for(var i=0;i<t.length;i++){if(!A(t[i])){r=false;break}}if(r){var s={};for(var i=0;i<t.length;i++){s[t[i]]=true}delete s["ID"];t=["ID"];for(var o in s){if(s.hasOwnProperty(o)){t.push(o)}}p(e,t);n=true}else{k("One or more field names in the table definition contains invalid characters.")}}return n},dropTable:function(e){c(e);d(e)},truncate:function(e){c(e);v(e)},alterTable:function(e,t,n){var r=false;if(!A(e)){k("The database name '"+e+"'"+" contains invalid characters.")}else{if(typeof t=="object"){var i=true;for(var s=0;s<t.length;s++){if(!A(t[s])){i=false;break}}if(i){var o={};for(var s=0;s<t.length;s++){o[t[s]]=true}delete o["ID"];t=[];for(var u in o){if(o.hasOwnProperty(u)){t.push(u)}}m(e,t,n);r=true}else{k("One or more field names in the table definition contains invalid characters.")}}else if(typeof t=="string"){if(A(t)){var a=[];a.push(t);m(e,a,n);r=true}else{k("One or more field names in the table definition contains invalid characters.")}}}return r},rowCount:function(e){c(e);return g(e)},insert:function(e,t){c(e);return y(e,M(e,t))},insertOrUpdate:function(e,t,n){c(e);var r=[];if(!t){r=S(e)}else if(typeof t=="object"){r=w(e,O(e,t))}else if(typeof t=="function"){r=E(e,t)}if(r.length==0){return y(e,M(e,n))}else{var i=[];for(var s=0;s<r.length;s++){T(e,r,function(e){i.push(e.ID);return n})}return i}},update:function(e,t,n){c(e);var r=[];if(!t){r=S(e)}else if(typeof t=="object"){r=w(e,O(e,t))}else if(typeof t=="function"){r=E(e,t)}return T(e,r,n)},query:function(e,t,n){c(e);var r=[];if(!t){r=S(e,n)}else if(typeof t=="object"){r=w(e,O(e,t),n)}else if(typeof t=="function"){r=E(e,t,n)}return b(e,r,n)},deleteRows:function(e,t){c(e);var n=[];if(!t){n=S(e)}else if(typeof t=="object"){n=w(e,O(e,t))}else if(typeof t=="function"){n=E(e,t)}return x(e,n)}}};